Добрый день, уважаемые студенты! Я рад вас видеть на очередной сессии обзора лабораторной работы. Тема сегодняшней лабораторной работы — это Scale & Load Balance your Architecture. Итак, давайте начнем. Самым первым делом, нам необходимо в AWS Academy открыть соответствующий курс Cloud Foundations, далее в левом навигационном меню перейти в Modules. На открывшейся странице спозиционируется на Module 10 – Auto Scaling and Monitoring, и вы увидите активность Lab 6 – Scale & Load Balance your Architecture. Давайте на нее нажмем, чтобы перейти на основную страницу лабораторной работы. Здесь мы можем скрыть окно Terminal, убрав галочку соответствующего пункта и оставить только README, для того чтобы удобнее было читать задание нашей лабораторной работы. Также вы можете параллельно нажать на кнопку Start Lab, для того чтобы начать инициирование временного AWS аккаунта для вашей сессии. В этой лабораторной работе мы подробнее изучим сервисы Elastic Load Balancing – ELB и Auto Scaling. ELB мы используем для того, чтобы балансировать трафик на наши таргеты, а Auto Scaling используем для того, чтобы динамически увеличивать либо уменьшать наши IT-ресурсы. Самый частый сервис, который используется в связке с ACG, т.е. Auto Scaling Group – это Amazon EC2 инстансы. Что мы сегодня будем с вами делать? Первое, мы создадим копию AMI уже работающего инстанса. Далее мы создадим load balancer, сконфигурируем и запустим Auto Scaling group, а также посмотрим, как все эти сервисы работают в связке, как происходит Auto Scaling, и мы можем также увидеть эти изменения в alarms и промониторить этот процесс в Amazon CloudWatch. Для выполнения этой лабораторной работы рекомендуется потратить 30 минут. Я напоминаю, что если вам нужно больше времени, то вы всегда можете обнулить счетчик и продолжить выполнение лабораторной работы. До начала нашей лабораторной работы мы видим, что текущая архитектура внутри AWS имеет следующий вид. Что будет сделано в рамках этой лабораторной работы это: мы создадим Load Balancer, перенесем наш Web Instance, который находился в Public Subnet 2, сверху справа, на Private Subnet и настроим связку Load Balancer и Auto Scaling. Таким образом у нас будут создаваться инстансы по необходимости в обеих Availability Zones, т.е. Availability Zone A и Availability Zone B. Самым первым делом для того, чтобы начать выполнение лабораторной работы, нам нужно добраться до AWS Management Console. Для этого, если вы еще не сделали, вам необходимо нажать на кнопку Start Lab, вверху справа. Как только вы на нее нажмете, появится всплывающее окошко, в котором будет указан статус лабораторной работы, т.е. "Lab Status: in creation". Как только поменяется статус на Ready, вы можете закрывать это окно и далее вам необходимо будет нажать на кнопку AWS, чтобы перейти на созданный для вашей сессии лабораторной работы временный AWS Account. Как только вы добрались до AWS Management Console, мы можем переходить к выполнению первого задания. Здесь нам необходимо создать копию AMI. Этот AMI будет использоваться для создания новых инстансов под Auto Scaling group. Для этого нам необходимо в строке поиска сервисов начать вводить EC2, либо нажать на кнопку Services и в выпадающем меню найти сервис EC2. Как только мы перейдем, в левом навигационном меню, нам необходимо выбрать Instances и отобразиться список всех инстансов в нашем AWS Account в конкретном регионе. Если вы не видите инстансы, то проверьте, что у вас стоит регион North Virginia или us-east-1. Вы должны увидеть инстанс с названием Web Server 1. Необходимо проверить, что в колонке Status Checks стоит 2/2, что говорит о том, что сервер был успешно создан и готов к работе. Как только вы это увидите, необходимо выбрать этот инстанс. Далее в пункте меню Actions выбрать опцию Image and Templates. Далее нажать на опцию Create Image. В открывшейся странице нам необходимо указать как Image name: WebServerAMI. Далее как Image description указать Lab AMI for Web Server и в самом внизу нажать на кнопку Create Image. Вы увидите новый созданный AMI и его соответствующий ID. Вам необходимо этот ID скопировать, так как мы ее будем использовать чуть позднее в следующем задании. Мы переходим ко второму заданию и здесь нам необходимо создать Load Balancer. Я напоминаю, что Load Balancer — это тот IT-ресурс, который помогает нам балансировать нагрузку на наши вычислительные мощности. В нашем случае - это Amazon EC2 Instances и мы настроим Load Balancer таким образом, чтобы оно балансировало трафик на несколько Availability Zones. Самым первым делом, нам необходимо создать Target Groups, т.е. это те ресурсы, которые показывают куда будет направляться трафик от Load Balancer. Необходимо в левом навигационном меню выбрать Target Groups. Далее в открывшейся странице нажать на кнопку Create target group. Как target type нам необходимо выбрать Instances, как Target group name давайте укажем LabGroup, и также нам необходимо указать VPC. В выпадающем меню давайте выберем Lab VPC. Далее нам необходимо нажать на кнопку Next и вы увидите секцию Register targets. На текущий момент у нас не созданы наши targets, поэтому мы можем пропустить этот шаг и нажать на кнопку Create target group. Теперь мы переходим непосредственно к созданию Load Balancer. Для этого в левом навигационном меню необходимо выбрать Load Balancers. В открывшейся странице нажмем на кнопку Create Load Balancer, откроется еще одна страница, в которой вам нужно будет выбрать тип нового создаваемого Load Balancer. Нас интересует Application Load Balancer, давайте нажмем на кнопку Create под этой опцией. Откроется страница для ввода свойств нового Load Balancer. Как name давайте укажем LabELB. Далее в настройках сети Network необходимо выбрать VPC, в нашем случае это Lab VPC. Далее после этого нам необходимо выбрать Availability Zones, для этого выбираем первую Availability Zone – us-east-1a. Здесь нам необходимо выбрать Public Subnet 1, то же самое необходимо проделать для второй Availability Zone и выбрать Public Subnet 2. В результате у вас должно быть выбрано два Subnet, это Public Subnet 1 и Public Subnet 2. Мы переходим к следующей секции — это Security groups. Здесь нам необходимо в выпадающем меню выбрать опцию Web Security Group. Также вы видите, что выбрана default security group, она нам не нужна, поэтому необходимо нажать на кнопку X и удалить default security group. В результате у нас останется одна единственная security group, которая называется Web Security Group. Самая последняя настройка – это Listener, т.е. на какой порт, по какому протоколу будет приходить трафик. В нашем случае это HTTP:80. И также здесь нам необходимо указать как Default action, перенаправлять трафик на LabGroup. На этом мы завершили ввод всех настроек для load balancer. Сейчас необходимо прокрутить самый низ страницы и нажать на кнопку Create load balancer. Вы увидите сообщение о том, что load balancer был успешно создан. Также вы можете нажать на кнопку View load balancer для того, чтобы открыть страницу нашего load balancer. Вы видите, что состояние сейчас provisioning, через некоторое время оно поменяется на состояние ready либо success. Таким образом будет готово к работе. Нам нет необходимости ждать того момента, когда load balancer будет готов, так как следующее задание создает следующие IT-ресурсы в сервисе Auto Scaling. Поэтому мы можем, не дождавшись изменения статуса, переходить к следующему заданию. Мы с вами переходим к третьему заданию. Это объемное задание. Здесь мы будем создавать Launch Configuration и Auto Scaling Group. Я вам напоминаю, что Auto Scaling Group – это тот IT-ресурс, который позволяет нам в зависимости от определенной метрики, например, нагрузка на CPU, изменять количество таргетов. В нашем случае это вычислительные мощности или Amazon EC2 инстансы. Таким образом, если повышается нагрузка на наши Amazon EC2 инстансы, то Auto Scaling Group автоматически создает новый инстанс для того, чтобы нагрузку распределить. В случае, если нагрузка минимальная, то и Auto Scaling Group видит, что у нас есть избыточное количество Amazon EC2 инстансов, то лишние Amazon EC2 инстансы будут автоматически отключаться. Итак, первым делом нам необходимо создать Launch Configuration. Для этого в левом навигационном меню необходимо выбрать опцию Launch Configurations. В открывшейся странице нажать на кнопку Create launch configuration и начать вводить данные по этому IT-ресурсу. Как name укажем LabConfig. Далее, как AMI, выберем ранее созданный нами AMI — это Web Server AMI. Как Instance type выберем t3.micro. Если же эта опция недоступна, то мы можем выбрать t2.micro. В следующей секции Additional configuration и под секцией Monitoring необходимо поставить галочку возле Enable EC2 instance detailed monitoring within CloudWatch. Это нужно для того, чтобы Auto Scaling быстрее реагировал на изменение нагрузки на наши инстансы. Следующая секция – это Security groups. Здесь нам необходимо выбрать опцию Select an existing security group, т.е. уже ранее созданный Security group и в выпадающем меню выбрать Web Security Group. Двигаемся дальше. Секция Key pair – это тот приватный ключ, который позволяет нам по SSH подключаться к нашим Amazon EC2 инстансам. Здесь нам необходимо выбрать опцию Choose an existing key pair и в выпадающем списке выбрать key pair: vockey. Также поставить галочку о том, что вы подтверждаете привязку этого ключа к создаваемым Amazon EC2 инстансам и нажать на кнопку Create launch configuration. Как только мы завершили создание Launch Configuration, мы на базе неё можем создать Auto Scaling group. Здесь вам необходимо проверить, что вы находитесь в нужном регионе, нужный регион – это North Virginia, либо us-east-1. Нам необходимо выбрать LabConfig из списка и нажать на кнопку Actions, в выпадающем меню выбрать опцию Create Auto Scaling group. Как только вы на нее нажмете, вас перенаправит на страницу создания Auto Scaling group. На этой странице в поле Name введем Lab Auto Scaling Group, нажмем на кнопку Next. Далее в настройках сети нам необходимо выбрать VPC, в нашем случае это Lab VPC. Здесь если вы увидите сообщение "No public IP address", то можете игнорировать это сообщение. Чуть ниже, там где необходимо выбрать Subnets, нам необходимо выбрать Private Subnet 1 и Private Subnet 2. Почему Private Subnet, не Public Subnet? Это связано с тем, что ранее у нас был один единственный Amazon EC2 инстанс, который не увеличивался в размерах, не в количестве, и это был статичный инстанс. В случае увеличения нагрузки, инстанс бы не выдержал эту нагрузку и отключался бы. Сейчас мы добавляем возможность динамического изменения наших вычислительных мощностей, в зависимости от нагрузки, и в этом случае ресурсом, который будет принимать трафик будет Load Balancer и Auto Scaling group, т.е. они уже будут находиться в Public Subnet. Таким образом для большей безопасности все наши инстансы под Load Balancer мы можем расположить в Private Subnet. После того, как мы выберем Subnets необходимо нажать на кнопку Next и в открывшейся странице там, где Load balancing - optional необходимо выбрать Attach to an existing load balancer. Как только мы на нее нажмем появится выпадающее меню, необходимо выбрать LabGroup. В секции Additional settings необходимо выбрать опцию и поставить галочку Enable group metrics collection within CloudWatch. Это нужно для того, чтобы метрики снимались каждую минуту, а это в свою очередь позволит быстрее реагировать нашей Auto Scaling group. Нажмем на кнопку Next. Здесь нам необходимо будет выбрать размеры нашей Group. Есть три параметра, это Desired Capacity, Minimum capacity и Maximum capacity. Desired capacity – это то количество таргетов, которое будет создано в самом начале создания Auto Scaling group. Minimum и Maximum capacity соответственно — это минимальное и максимальное количество таргетов, которое может создавать Auto Scaling group. И здесь такой момент, нужно понимать какое правильное значение выставить для минимума и в частности для максимума, чтобы не израсходовать средства компании слишком много, но при этом обработать максимально возможное количество запросов от ваших пользователей. Представим, что вы указали Maximum capacity:6 и нагрузка она внезапно увеличилась и даже 6 инстансов не смогли обработать запросы всех ваших пользователей. В этом случае вам рекомендуется настроить дополнительные уведомления о том, что 6 инстансов недостаточно для обработки текущей нагрузки, поэтому необходимо подключиться и вручную поменять это значение. Либо изначально получить добро от руководства о том, что при увеличении нагрузки мы в приоритет ставим обслуживание всех запросов от пользователей, при этом количество инстансов может быть увеличено до 10-20 инстансов. Это будет стоить дороже, но вы получите гарантию того, что все ваши пользователи будут соответствующие обработаны вашим приложением. Двигаемся дальше. В секции Scaling Policies нам необходимо выбрать Target tracking scaling policy и его настроить: как Lab policy name укажем LabScalingPolicy, как Metric type выберем Average CPU Utilization, т.е. мы будем смотреть на нагрузку, на наши процессоры, и как Target value укажем 60. Когда мы указываем 60, это говорит о том, что Auto Scaling будет стремиться к тому, чтобы нагрузка на все наши таргеты была в районе 60%. Если она увеличивается, это говорит о том, что нагрузка поднялась и нам необходимо добавить дополнительные таргеты. Если же нагрузка упала порядка 40 либо ниже процентов, то в этом случае Auto Scaling group понимает, что текущие таргеты с легкостью справляются с нагрузкой и она может один или несколько таргетов удалить. Мы переходим к заключительной части этого задания. Нам необходимо нажать на кнопку Next. Здесь нам необходимо указать теги. Давайте добавим один тег, как Key укажем Name и как Value укажем Lab Instance. Нажмем на кнопку Next и на этом откроется страница, где мы можем пересмотреть все введенные нами настройки. Если все указано верно, мы можем нажать в самом низу на кнопку Create Auto Scaling Group. Если же вы получите ошибку Failed to create Auto Scaling Group, необходимо нажать на появившуюся кнопку Retry Failed Tasks, после чего Auto Scaling group должна быть успешно создана. Обратите внимание, что в самом начале количество инстансов будет равно нулю и со временем будут подниматься новые инстансы в количестве равном Desired capacity, т.е. в итоге у нас будет два инстанса поднятых и готовых к работе. Мы переходим к четвертому заданию и здесь мы будем проверять, что связка всех IT-ресурсов, созданных нами ранее, работает корректно. Самым первым делом нам необходимо перейти в левом навигационном меню в пункт Instances. Здесь вы увидите, что появятся дополнительные два новых инстанса с названием Lab Instance. Почему Lab Instance? При создании Auto Scaling group мы давали ей тег Name со значением Lab Instance. Таким образом Auto Scaling group для всех созданных от себя инстансов передала свои теги. Здесь необходимо дождаться, что Health Checks для этих двух Lab Instance будут пройдены. Как только это будет готово, вы можете в левом навигационном меню переходить к следующей вкладке – это Target Groups. Вы увидите, что в списке есть одна единственная target group – это LabGroup. Давайте на нее нажмем и во вкладке Targets вы увидите наши два инстанса. Здесь нам необходимо дождаться, что статус обоих инстансов перейдет в состояние Healthy. Для этого время от времени вы можете нажимать на кнопку Refresh. Как только они перейдут в состояние Healthy, это говорит о том, что они сейчас доступны для приема запросов от Load Balancer и соответственно, Load Balancer готов направлять трафик на эти таргеты. Теперь давайте посмотрим все ли нормально с точки зрения Auto Scaling group и Load Balancer. Нам необходимо в левом навигационном меню нажать на Load Balancers и в нижней части скопировать DNS Name, созданного нами Load Balancer. Как только вы ее скопируете, вы можете ее вставить в новую вкладку в вашем веб-браузере и открыть эту страницу. Откроется подготовленная специально для этой лабораторной работы простое приложение и вы увидите какой-то ответ. Это говорит о том, что мы отправили запрос Load Balancer, Load Balancer направил трафик на инстансы, созданные Auto Scaling group, инстанс обработал этот запрос и вернул какой-то ответ. Этот ответ вы видите в виде вашей страницы, на котором отображается приложение. Таким образом мы подтвердили для себя, что связка Auto Scaling group и Load Balancer работает корректно. Теперь мы переходим к последнему заданию — это тестирование нашего Auto Scaling, т.е. нам необходимо проверить, что при увеличении нагрузки на наши инстансы, Auto Scaling автоматически добавляет новые инстансы, чтобы эту нагрузку распределить по большему количеству таргетов. Для этого нам необходимо перейти на другой сервис, это CloudWatch. Давайте в строке поиска сервисов начнем вводить CloudWatch, либо можете начать вводить Watch, в принципе работает полнотекстовый поиск. Поэтому любое сочетание символов она будет искать в названии сервиса. Как только вы переходите на страницу сервиса CloudWatch в левом навигационном меню, вам необходимо выбрать опцию All Alarms. Вам должны быть отображены два alarms, обе они были автоматически созданы Auto Scaling group. Эти два alarms по очереди тригерят Auto Scaling group в зависимости от нагрузки на ваши Amazon EC2 инстансы, что в свою очередь иницирует удаление или создание новых инстансов в Auto Scaling group. Если же эти alarms не отображаются, обратите внимание, сидите ли вы в корректном регионе. Нам нужен регион North Virginia, либо us-east-1. Если же вы сидите в правильном регионе, тем не менее эти alarms не отображаются, нам необходимо проделать некоторые действия. Эти действия необходимо производить только во временно созданном AWS аккаунте. В реальном AWS аккаунте подобных проблем не будет. Итак, если alarm не отображается, вам необходимо перейти в сервис Amazon EC2, далее в левом навигационном меню выбрать опцию Auto Scaling Groups, выбрать Auto Scaling group, созданную ранее нами, называется Lab Auto Scaling Group. Далее, как только мы ее выберем, в нижней части экрана отобразятся несколько вкладок. Нам необходимо открыть вкладку Automatic Scaling. Необходимо там в списке выбрать LabScalingPolicy, нажать на кнопку Actions и в выпадающем меню выбрать опцию Edit. Откроется всплывающее окно и как Target Value необходимо указать 50 и нажать на кнопку Update. Это инициирует повторное создание подресурсов Auto Scaling group и после этого обновления вы в CloudWatch сервисе можете увидеть, что эти alarms появились. Обратите внимание, что эти alarms появляются не сразу и вам необходимо как минимум 1-2 минуты подождать после чего обновить страницу. Как только наши alarms появились, нам необходимо выбрать alarm с названием AlarmHigh в названии. Мы видим, что ее состояние OK. Если же отображается не OK, то необходимо подождать некоторое время и нажать на кнопку refresh. Оно должно вернуться в состояние OK. OK означает то, что нагрузка на наши инстансы на CPU меньше 60%. Как только оно увеличивается и становится больше 60%, то этот alarm из состояния OK переходит в состояние Alarm и отправляет соответствующую информацию в Auto Scaling group. Сейчас нам необходимо протестировать, что действительно Auto Scaling group работает. Для этого нам необходимо вернуться в наше приложение, открытое ранее в веб-браузере в отдельной вкладке и нажать на кнопку Load Test. Как только вы на нее нажмете, то запустятся скрипты, которые дадут нагрузку на наши инстансы. Обратите внимание, что эту страницу закрывать нельзя. Если вы закроете эту страницу, то нагрузка прекратится. Нам необходимо подождать некоторое время, чтобы метрики передались в AWS и соответствующие ресурсы были уведомлены. Вы можете периодически нажимать на кнопку Refresh и вы увидите, что меньше чем за 5 минут, AlarmLow, он должен поменять свое значение на OK, а AlarmHigh, наоборот должен поменять свое состояние на In alarm, т.е. говорит о том, что сейчас большая нагрузка на наши инстансы. Также если вы откроете соответствующий alarm, в нашем случае AlarmHigh, то вы увидите увеличивающуюся нагрузку на CPU в виде графика. Как только оно переходит 60% либо 50%, если мы пересоздавали наши alarms и это длится больше чем 3 минуты, то оно триггернет Auto Scaling group, а оно в свою очередь добавит новые инстансы. Нам необходимо дождаться, пока AlarmHigh перейдет в состояние In alarm. Как только оно туда перейдет, вы можете перейти в сервис Amazon EC2, открыть в левом навигационном меню опцию Instances и убедиться, что сейчас у нас количество инстансов с названием Lab Instance больше двух, три либо четыре. Это говорит о том, что Auto Scaling верно работает и для того, чтобы распределить нагрузку, оно создало дополнительные инстансы. Как только вы в этом убедитесь, вы можете закрывать страницу с приложением для того, чтобы нагрузка вернулась в обычное состояние. Также вы можете подождать как минимум 5 минут для того, чтобы количество инстансов из трех и четырех вернулось обратно к минимальному значению 2. Как только вы доберете до этого состояния, я хочу от себя предложить провести дополнительный эксперимент. Вам необходимо в сервисе Amazon EC2, в левом навигационном меню Instances, выбрать один из инстансов с названием Lab Instance и через кнопку Actions этот инстанс терминейтнуть, т.е. отключить. Как только вы ее отключите, вы увидите в Load Balancer, что один из таргетов стал unhealthy и после чего трафик перестает направляться на этот инстанс. Auto Scaling соответственно видит, что количество инстансов стало меньше, чем минимальное значение и иницирует создание нового инстанса. Через некоторое время вы увидите, что был создан еще один дополнительный инстанс и будет отображено два инстанса. Мы переходим к последнему заданию. Мы в самом начале создавали AMI от инстанса с названием Web Server 1. Вы видите, что этот сервер нам уже не нужен, так как сейчас трафик он направляется не на этот Web server, а на Load Balancer. Таким образом мы можем этот сервер удалять. Для этого необходимо в списке инстансов выбрать Web Server 1, далее нажать на кнопку Instance state и выбрать опцию Terminate Instance. Также во всплывающем меню необходимо подтвердить о том, что мы отключаем этот инстанс. На этом мы добрались до конца нашей лабораторной работы. Я вам напоминаю, что вам необходимо корректно отключить/разлогиниться из временного AWS аккаунта. Также вам необходимо в AWS Academy, на странице лабораторной работы нажать на кнопку End Lab, подтвердить и дождаться сообщения о том, что "DELETE has been initiated... You may close this message box now." что говорит о том, что процесс удаления всех созданных ресурсов и аккаунтов инициирован, и вы можете закрывать это окно. Вы закрываете это всплывающее окно, также можете закрывать вкладку с AWS Academy, и на этом вы успешно завершили лабораторную работу. Еще раз хотел бы вас поздравить завершением лабораторной работы. Я очень надеюсь, что многие вопросы были отвечены, вы получили более полное представление о сервисах ELB и Auto Scaling. Если будут вопросы, то задавайте, а мы с вами увидимся на следующих наших активностях.